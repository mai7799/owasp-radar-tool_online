import { updateEChartsChartTitle, downloadChart } from './chart-common.js';

// --- 全局變數 ---
const echartsCategories_VulnMap = [
    { id: 'A01', name: 'A01: 權限控制失效' }, { id: 'A02', name: 'A02: 加密機制失效' },
    { id: 'A03', name: 'A03: 注入式攻擊' }, { id: 'A04', name: 'A04: 不安全設計' },
    { id: 'A05', name: 'A05: 安全設定弱點' }, { id: 'A06', name: 'A06: 危險或過舊的元件' },
    { id: 'A07', name: 'A07: 認證及驗證機制失效' }, { id: 'A08', name: 'A08: 軟體及資料完整性失效' },
    { id: 'A09', name: 'A09: 資安記錄及監控失效' }, { id: 'A10', name: 'A10: 伺服端請求偽造' }
];
let vulnerabilitiesForVulnMap = [];
let echartsRadarInstance = null;

// --- 函式定義 ---
function populateVulnCategoryDropdown() {
    const categorySelect = document.getElementById('vulnCategoryInMap');
    if (!categorySelect) return;
    categorySelect.innerHTML = '';
    echartsCategories_VulnMap.forEach((cat, index) => {
        const option = document.createElement('option');
        option.value = index; // Use index as value
        option.textContent = cat.name;
        categorySelect.appendChild(option);
    });
}

function updateVulnTableInMapTab() {
    const listElement = document.getElementById('vulnerabilityListInMap');
    if (!listElement) return;
    listElement.innerHTML = '';
    vulnerabilitiesForVulnMap.forEach((vuln, index) => {
        const li = document.createElement('li');
        const severityScore = vuln.severity;
        let severityClass = '';
        if (severityScore >= 9.0) severityClass = 'sev-critical';
        else if (severityScore >= 7.0) severityClass = 'sev-high';
        else if (severityScore >= 4.0) severityClass = 'sev-medium';
        else severityClass = 'sev-low';

        li.innerHTML = `
            <span>
                <span class="severity-legend" style="margin-right: 5px;"><span class="${severityClass}"></span></span>
                <strong>${echartsCategories_VulnMap[vuln.categoryIndex].id}:</strong> ${vuln.name} (${vuln.severity})
            </span>
            <button class="delete-btn" data-index="${index}">刪除</button>
        `;
        listElement.appendChild(li);
    });
     // Re-add event listeners for delete buttons
    listElement.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', (e) => {
            const indexToRemove = parseInt(e.target.dataset.index, 10);
            vulnerabilitiesForVulnMap.splice(indexToRemove, 1);
            updateVulnTableInMapTab(); // Rerender table
            updateEchartsRadarForVulnMap(); // Update chart
        });
    });
}

function updateEchartsRadarForVulnMap() {
    if (!echartsRadarInstance) return;
    const categoryMaxScores = Array(10).fill(0);
    vulnerabilitiesForVulnMap.forEach(vuln => {
        categoryMaxScores[vuln.categoryIndex] = Math.max(categoryMaxScores[vuln.categoryIndex], vuln.severity);
    });
    echartsRadarInstance.setOption({
        series: [{ data: [{ value: categoryMaxScores }] }]
    });
}

function addVulnToMap() {
    const nameInput = document.getElementById('vulnNameInMap');
    const categorySelect = document.getElementById('vulnCategoryInMap');
    const severityInput = document.getElementById('vulnSeverityInMap');

    const name = nameInput.value.trim();
    const categoryIndex = parseInt(categorySelect.value, 10);
    const severity = parseFloat(severityInput.value);

    if (!name) { alert('請輸入弱點名稱'); return; }
    if (isNaN(severity) || severity < 0.1 || severity > 10) { alert('請輸入有效的嚴重度分數 (0.1 - 10)'); return; }

    vulnerabilitiesForVulnMap.push({ name, categoryIndex, severity });
    vulnerabilitiesForVulnMap.sort((a, b) => b.severity - a.severity); // Sort by severity

    updateVulnTableInMapTab();
    updateEchartsRadarForVulnMap();

    nameInput.value = ''; // Clear input
    nameInput.focus();
}

function resetVulnMap() {
    if (confirm('確定要清除所有弱點資料嗎？')) {
        vulnerabilitiesForVulnMap = [];
        updateVulnTableInMapTab();
        updateEchartsRadarForVulnMap();
    }
}

function parseWordForVulnMap() {
    // 請從您的原始 index.html.txt 檔案中，將 parseWordForVulnMap 函式的完整內容複製到此處
    alert("請將 parseWordForVulnMap 函式的內容從原始碼貼上");
}

function initEchartsForVulnMapTab() {
    const chartDom = document.getElementById('owaspRadarChart');
    if (!chartDom) return;
    echartsRadarInstance = echarts.init(chartDom);
    window.echartsRadarInstance = echartsRadarInstance; // 掛載到 window 供 main.js 使用

    const option = {
        title: { text: document.getElementById('vulnerabilityMapChartTitle').value, left: 'center' },
        tooltip: { trigger: 'item' },
        legend: { data: ['弱點嚴重度'], bottom: 5 },
        radar: { indicator: echartsCategories_VulnMap.map(c => ({ name: c.name, max: 10 })) },
        series: [{
            name: '弱點嚴重度', type: 'radar',
            data: [{ value: Array(10).fill(0), name: '弱點嚴重度' }],
            areaStyle: { color: 'rgba(255, 107, 51, 0.4)' },
            lineStyle: { color: 'rgb(255, 107, 51)' }
        }]
    };
    echartsRadarInstance.setOption(option);
}

// --- 初始化函式 ---
export function init() {
    populateVulnCategoryDropdown();
    initEchartsForVulnMapTab();
    updateVulnTableInMapTab();

    // 綁定事件
    document.getElementById('addVulnToMapBtn').addEventListener('click', addVulnToMap);
    document.getElementById('resetVulnMapBtn').addEventListener('click', resetVulnMap);
    document.getElementById('updateVulnMapTitleBtn').addEventListener('click', () => updateEChartsChartTitle(echartsRadarInstance, 'vulnerabilityMapChartTitle'));
    document.getElementById('downloadVulnMapImageBtn').addEventListener('click', () => downloadChart('owaspRadarChart', true, echartsRadarInstance));
    
    const wordFileInput = document.getElementById('vulnMapWordFile');
    document.getElementById('parseVulnMapWordBtn').addEventListener('click', () => wordFileInput.click());
    wordFileInput.addEventListener('change', parseWordForVulnMap);
}